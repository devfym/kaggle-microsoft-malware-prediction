###########################################
# Load Packages
###########################################

import pandas as pd
import numpy as np

from sklearn.metrics import roc_auc_score
from sklearn.model_selection import KFold

from lightgbm import LGBMClassifier
import gc

###########################################
# Load dataset
###########################################

train = pd.read_csv('train_5.csv.zip', compression='zip')
test = pd.read_csv('test_5.csv.zip', compression='zip')

###########################################
# Exclude Features
###########################################

y = train['HasDetections']
del train['HasDetections']

excluded_feats = ['MachineIdentifier']

remove_col = [
    'Census_OSVersion_Percentage',
    'Census_OSBuildNumber_Percentage', # Redundant with OsBuild and Census_OSVersion_3
    'Census_OSBuildRevision_Percentage', #Redundant with Census_OSVersion_4
    'Census_OSArchitecture_Percentage', # Redundant with OsBuildLab_2
    'Processor_Percentage', # Redundant with OsBuildLab_2
    'OsBuildLab_3_Percentage', # Redundant with OsPlatformSubRelease and Census_OSBranch
    'Census_OSSkuName_Percentage', # Redundant with Census_OSEdition
    'OsBuild_Percentage' # Nothing important
]
for i in range(len(remove_col)):
    del train[remove_col[i]]
    del test[remove_col[i]]

    features = [f_ for f_ in train.columns if f_ not in excluded_feats]

remove_col = [
    'AppVersion',
    'AvSigVersion',
    'OsVer',
    'Census_OSVersion'
]
for i in range(len(remove_col)):
    del train[remove_col[i] + '_1_Percentage']
    del test[remove_col[i]  + '_1_Percentage']
    del train[remove_col[i] + '_2_Percentage']
    del test[remove_col[i]  + '_2_Percentage']
    del train[remove_col[i] + '_3_Percentage']
    del test[remove_col[i]  + '_3_Percentage']
    del train[remove_col[i] + '_4_Percentage']
    del test[remove_col[i]  + '_4_Percentage']

remove_col = [
    'Wdft_IsGamer_Percentage',
    'Wdft_RegionIdentifier_Percentage'
]
for i in range(len(remove_col)):
    del train[remove_col[i]]
    del test[remove_col[i]]

###########################################
# 2-Folds LightGBM
###########################################

folds = KFold(n_splits=2, shuffle=True, random_state=219)
oof_preds = np.zeros(train.shape[0])
sub_preds = np.zeros(test.shape[0])

for n_fold, (trn_idx, val_idx) in enumerate(folds.split(train)):
    trn_x, trn_y = train[features].iloc[trn_idx], y.iloc[trn_idx]
    val_x, val_y = train[features].iloc[val_idx], y.iloc[val_idx]

    clf = LGBMClassifier(
        boosting_type='gbdt',
        objective='binary',
        n_estimators=1500,
        learning_rate=0.01,
        num_leaves=2**8-1,
        colsample_bytree=.8,
        subsample=.8,
        reg_alpha=.1,
        reg_lambda=.1,
        min_split_gain=.01,
        min_child_weight=2
    )

    clf.fit(trn_x, trn_y, eval_set= [(trn_x, trn_y), (val_x, val_y)], eval_metric='auc', verbose=100, early_stopping_rounds=100)

    oof_preds[val_idx] = clf.predict_proba(val_x, num_iteration=clf.best_iteration_)[:, 1]
    sub_preds += clf.predict_proba(test[features], num_iteration=clf.best_iteration_)[:, 1] / folds.n_splits

    print('Fold %2d AUC : %.6f' % (n_fold + 1, roc_auc_score(val_y, oof_preds[val_idx])))
    del clf, trn_x, trn_y, val_x, val_y
    gc.collect()

print('Full AUC score %.6f' % roc_auc_score(y, oof_preds))

###########################################
# SAVE
###########################################

test['HasDetections'] = sub_preds
test[['MachineIdentifier', 'HasDetections']].to_csv('submission_best_private_score.csv', index=False, float_format='%.8f')
