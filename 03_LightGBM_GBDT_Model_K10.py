###########################################
# Load Packages
###########################################

import pandas as pd
import numpy as np

from sklearn.metrics import roc_auc_score
from sklearn.model_selection import KFold

from lightgbm import LGBMClassifier
import gc

###########################################
# Load dtypes
###########################################

dtypes = {
    'MachineIdentifier':'category',
    'ProductName':'category',
    'Platform':'category',
    'SkuEdition':'category',
    'PuaMode':'category',
    'SmartScreen':'category',
    'Census_MDC2FormFactor':'category',
    'Census_DeviceFamily':'category',
    'Census_ProcessorClass':'category',
    'Census_PrimaryDiskTypeName':'category',
    'Census_ChassisTypeName':'category',
    'Census_PowerPlatformRoleName':'category',
    'Census_InternalBatteryType':'category',
    'Census_OSEdition':'category',
    'Census_OSSkuName':'category',
    'Census_OSInstallTypeName':'category',
    'Census_OSWUAutoUpdateOptionsName':'category',
    'Census_GenuineStateName':'category',
    'Census_ActivationChannel':'category',
    'Census_FlightRing':'category',
    'OsBuildLab_2':'category',
    'OsBuildLab_3':'category'
}

###########################################
# Load dataset
###########################################

train = pd.read_csv('train_3.csv.zip', dtype=dtypes, compression='zip')
test = pd.read_csv('test_3.csv.zip', dtype=dtypes, compression='zip')

###########################################
# Exclude Features
###########################################

y = train['HasDetections']
del train['HasDetections']

excluded_feats = ['MachineIdentifier']

del train['Census_OSArchitecture']
del train['Census_OSBranch']
del train['OsPlatformSubRelease']
del train['Processor']

del test['Census_OSArchitecture']
del test['Census_OSBranch']
del test['OsPlatformSubRelease']
del test['Processor']

features = [f_ for f_ in train.columns if f_ not in excluded_feats]

###########################################
# 10-folds LightGBM
###########################################

folds = KFold(n_splits=10, shuffle=True, random_state=219)
oof_preds = np.zeros(train.shape[0])
sub_preds = np.zeros(test.shape[0])

for n_fold, (trn_idx, val_idx) in enumerate(folds.split(train)):
    trn_x, trn_y = train[features].iloc[trn_idx], y.iloc[trn_idx]
    val_x, val_y = train[features].iloc[val_idx], y.iloc[val_idx]

    clf = LGBMClassifier(
        boosting_type='gbdt', #same
        objective='binary',   #same
        n_estimators=1500,    #diff boosting
        learning_rate=0.01,   #same
        num_leaves=2500,       #same
        colsample_bytree=.8,  #same
        subsample=.8,         #same
        reg_alpha=.1,         #diff
        reg_lambda=.1,        #diff
        min_split_gain=.01,   #diff
        min_child_weight=2    #diff
    )

    clf.fit(trn_x, trn_y, eval_set= [(trn_x, trn_y), (val_x, val_y)], eval_metric='auc',  verbose=300, early_stopping_rounds=100)

    oof_preds[val_idx] = clf.predict_proba(val_x, num_iteration=clf.best_iteration_)[:, 1]
    sub_preds += clf.predict_proba(test[features], num_iteration=clf.best_iteration_)[:, 1] / folds.n_splits

    print('Fold %2d AUC : %.6f' % (n_fold + 1, roc_auc_score(val_y, oof_preds[val_idx])))
    del clf, trn_x, trn_y, val_x, val_y
    gc.collect()

print('Full AUC score %.6f' % roc_auc_score(y, oof_preds))

###########################################
# Save
###########################################

test['HasDetections'] = sub_preds
test[['MachineIdentifier', 'HasDetections']].to_csv('submission_lightgbm_k10.csv', index=False, float_format='%.8f')
