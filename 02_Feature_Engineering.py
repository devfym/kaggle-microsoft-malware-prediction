###########################################
# Load Packages
###########################################

import pandas as pd
import numpy as np
import gc

###########################################
# Load dtypes
###########################################

dtypes = {
    'MachineIdentifier':'category',
    'ProductName':'category',
    'EngineVersion':'category',
    'AppVersion':'category',
    'AvSigVersion':'category',
    'IsBeta':'int8',
    'RtpStateBitfield':'float16',
    'IsSxsPassiveMode':'int8',
    'DefaultBrowsersIdentifier':'float16',
    'AVProductStatesIdentifier':'float32',
    'AVProductsInstalled':'float16',
    'AVProductsEnabled':'float16',
    'HasTpm':'int8',
    'CountryIdentifier':'int16',
    'CityIdentifier':'float32',
    'OrganizationIdentifier':'float16',
    'GeoNameIdentifier':'float16',
    'LocaleEnglishNameIdentifier':'int8',
    'Platform':'category',
    'Processor':'category',
    'OsVer':'category',
    'OsBuild':'int16',
    'OsSuite':'int16',
    'OsPlatformSubRelease':'category',
    'OsBuildLab':'category',
    'SkuEdition':'category',
    'IsProtected':'float16',
    'AutoSampleOptIn':'int8',
    'PuaMode':'category',
    'SMode':'float16',
    'IeVerIdentifier':'float16',
    'SmartScreen':'category',
    'Firewall':'float16',
    'UacLuaenable':'float32',
    'Census_MDC2FormFactor':'category',
    'Census_DeviceFamily':'category',
    'Census_OEMNameIdentifier':'float16',
    'Census_OEMModelIdentifier':'float32',
    'Census_ProcessorCoreCount':'float16',
    'Census_ProcessorManufacturerIdentifier':'float16',
    'Census_ProcessorModelIdentifier':'float16',
    'Census_ProcessorClass':'category',
    'Census_PrimaryDiskTotalCapacity':'float32',
    'Census_PrimaryDiskTypeName':'category',
    'Census_SystemVolumeTotalCapacity':'float32',
    'Census_HasOpticalDiskDrive':'int8',
    'Census_TotalPhysicalRAM':'float32',
    'Census_ChassisTypeName':'category',
    'Census_InternalPrimaryDiagonalDisplaySizeInInches':'float16',
    'Census_InternalPrimaryDisplayResolutionHorizontal':'float16',
    'Census_InternalPrimaryDisplayResolutionVertical':'float16',
    'Census_PowerPlatformRoleName':'category',
    'Census_InternalBatteryType':'category',
    'Census_InternalBatteryNumberOfCharges':'float32',
    'Census_OSVersion':'category',
    'Census_OSArchitecture':'category',
    'Census_OSBranch':'category',
    'Census_OSBuildNumber':'int16',
    'Census_OSBuildRevision':'int32',
    'Census_OSEdition':'category',
    'Census_OSSkuName':'category',
    'Census_OSInstallTypeName':'category',
    'Census_OSInstallLanguageIdentifier':'float16',
    'Census_OSUILocaleIdentifier':'int16',
    'Census_OSWUAutoUpdateOptionsName':'category',
    'Census_IsPortableOperatingSystem':'int8',
    'Census_GenuineStateName':'category',
    'Census_ActivationChannel':'category',
    'Census_IsFlightingInternal':'float16',
    'Census_IsFlightsDisabled':'float16',
    'Census_FlightRing':'category',
    'Census_ThresholdOptIn':'float16',
    'Census_FirmwareManufacturerIdentifier':'float16',
    'Census_FirmwareVersionIdentifier':'float32',
    'Census_IsSecureBootEnabled':'int8',
    'Census_IsWIMBootEnabled':'float16',
    'Census_IsVirtualDevice':'float16',
    'Census_IsTouchEnabled':'int8',
    'Census_IsPenCapable':'int8',
    'Census_IsAlwaysOnAlwaysConnectedCapable':'float16',
    'Wdft_IsGamer':'float16',
    'Wdft_RegionIdentifier':'float16',
    'HasDetections':'int8'
}

###########################################
# Load dataset
###########################################

train = pd.read_csv('train_2.csv.zip', dtype=dtypes, compression='zip')
test = pd.read_csv('test_2.csv.zip', dtype=dtypes, compression='zip')

test['HasDetections'] = np.nan
df = pd.concat([train,test])

gc.enable()

del train, test

total_index = df.shape[0]

gc.collect()

###########################################
# Define Functions
###########################################

def GetPercentage(df_col):
    getp = dict(df_col.value_counts())
    for key in getp:
        getp.update({key : round(int(getp[key]) / total_index * 100, 4)})
    getdf = pd.DataFrame.from_dict(getp,'index')
    getdf.columns = [df_col.name + '_Percentage']
    del df_col, getp
    gc.collect()
    return getdf

def VersionToNumerical(col_df):
    colname = col_df.name
    col_df = col_df.str.extract('(\d+).(\d+).(\d+).(\d+)',expand=True)
    for key,value in col_df.iteritems():
        c = col_df[key].map(len).max()
        col_df[key] = col_df[key].apply(lambda x: x.zfill(c))
    df[colname + str('_1')] = col_df[0]
    df[colname + str('_2')] = col_df[1]
    df[colname + str('_3')] = col_df[2]
    df[colname + str('_4')] = col_df[3]
    col_df = col_df[0] + col_df[1] + col_df[2] + col_df[3]
    gc.collect()
    return col_df

###########################################
# Get Percentage of identifier
###########################################

identifier = [
    'DefaultBrowsersIdentifier',
    'AVProductStatesIdentifier',
    'CountryIdentifier',
    'CityIdentifier',
    'OrganizationIdentifier',
    'GeoNameIdentifier',
    'LocaleEnglishNameIdentifier',
    'IeVerIdentifier',
    'Census_OEMNameIdentifier',
    'Census_OEMModelIdentifier',
    'Census_ProcessorManufacturerIdentifier',
    'Census_ProcessorModelIdentifier',
    'Census_OSInstallLanguageIdentifier',
    'Census_OSUILocaleIdentifier',
    'Census_FirmwareManufacturerIdentifier',
    'Census_FirmwareVersionIdentifier',
    'Wdft_RegionIdentifier',
]

for i in range(len(identifier)):
    df = df.merge(GetPercentage(df[identifier[i]]), left_on=identifier[i], right_index=True, how='left').fillna(np.nan)
    gc.collect()

###########################################
# Divide Version Numbers
###########################################

version = ['EngineVersion','AppVersion','AvSigVersion','OsVer','Census_OSVersion']

for i in range(len(version)):
    df[version[i]] = VersionToNumerical(df[version[i]]).astype(np.int64)
    gc.collect()

###########################################
# Get Percentage of Versions (by whole)
###########################################

for i in range(len(version)):
    df = df.merge(GetPercentage(df[version[i]]), left_on=version[i], right_index=True, how='left').fillna(np.nan)
    gc.collect()

###########################################
# Get Percentage of Versions (by part)
###########################################

for x in range(1,5):
    for i in range(len(version)):
        version_part = version[i] + '_' + x
        df = df.merge(GetPercentage(df[version_part]), left_on=version_part, right_index=True, how='left').fillna(np.nan)
        gc.collect()

###########################################
# Get Percentage of other columns
###########################################

other = [
    'ProductName',
    'RtpStateBitfield',
    'AVProductsInstalled',
    'AVProductsEnabled',
    'Platform',
    'Processor',
    'OsBuild',
    'OsSuite',
    'OsPlatformSubRelease',
    'SkuEdition',
    'AutoSampleOptIn',
    'PuaMode',
    'SMode',
    'IeVerIdentifier',
    'SmartScreen',
    'Firewall',
    'UacLuaenable',
    'Census_MDC2FormFactor',
    'Census_DeviceFamily',
    'Census_ProcessorCoreCount',
    'Census_ProcessorClass',
    'Census_PrimaryDiskTotalCapacity',
    'Census_PrimaryDiskTypeName',
    'Census_SystemVolumeTotalCapacity',
    'Census_HasOpticalDiskDrive',
    'Census_TotalPhysicalRAM',
    'Census_ChassisTypeName',
    'Census_InternalPrimaryDiagonalDisplaySizeInInches',
    'Census_InternalPrimaryDisplayResolutionHorizontal',
    'Census_InternalPrimaryDisplayResolutionVertical',
    'Census_PowerPlatformRoleName',
    'Census_InternalBatteryType',
    'Census_InternalBatteryNumberOfCharges',
    'Census_OSArchitecture',
    'Census_OSBranch',
    'Census_OSBuildNumber',
    'Census_OSBuildRevision',
    'Census_OSEdition',
    'Census_OSSkuName',
    'Census_OSInstallTypeName',
    'Census_OSWUAutoUpdateOptionsName',
    'Census_IsPortableOperatingSystem',
    'Census_GenuineStateName',
    'Census_ActivationChannel',
    'Census_FlightRing',
    'OsBuildLab_1',
    'OsBuildLab_2',
    'OsBuildLab_3',
]

for i in range(len(other)):
    df = df.merge(GetPercentage(df[other[i]]), left_on=other[i], right_index=True, how='left').fillna(np.nan)
    gc.collect()

###########################################
# Save
###########################################

train_df = df.loc[:8921482,]
test_df = df[df['HasDetections'].apply(np.isnan)]
del test_df['HasDetections']
gc.collect()

train_df.to_csv('train_3.csv.zip', index=False, compression='zip')
test_df.to_csv('test_3.csv.zip', index=False, compression='zip')
gc.collect()
