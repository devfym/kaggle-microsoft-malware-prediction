###########################################
# Load Packages
###########################################

import pandas as pd
import numpy as np
import gc

###########################################
# Load dtypes
###########################################

dtypes = {
    'MachineIdentifier':'category',
    'ProductName':'category',
    'EngineVersion':'category',
    'AppVersion':'category',
    'AvSigVersion':'category',
    'IsBeta':'int8',
    'RtpStateBitfield':'float16',
    'IsSxsPassiveMode':'int8',
    'DefaultBrowsersIdentifier':'float16',
    'AVProductStatesIdentifier':'float32',
    'AVProductsInstalled':'float16',
    'AVProductsEnabled':'float16',
    'HasTpm':'int8',
    'CountryIdentifier':'int16',
    'CityIdentifier':'float32',
    'OrganizationIdentifier':'float16',
    'GeoNameIdentifier':'float16',
    'LocaleEnglishNameIdentifier':'int8',
    'Platform':'category',
    'Processor':'category',
    'OsVer':'category',
    'OsBuild':'int16',
    'OsSuite':'int16',
    'OsPlatformSubRelease':'category',
    'OsBuildLab':'category',
    'SkuEdition':'category',
    'IsProtected':'float16',
    'AutoSampleOptIn':'int8',
    'PuaMode':'category',
    'SMode':'float16',
    'IeVerIdentifier':'float16',
    'SmartScreen':'category',
    'Firewall':'float16',
    'UacLuaenable':'float32',
    'Census_MDC2FormFactor':'category',
    'Census_DeviceFamily':'category',
    'Census_OEMNameIdentifier':'float16',
    'Census_OEMModelIdentifier':'float32',
    'Census_ProcessorCoreCount':'float16',
    'Census_ProcessorManufacturerIdentifier':'float16',
    'Census_ProcessorModelIdentifier':'float16',
    'Census_ProcessorClass':'category',
    'Census_PrimaryDiskTotalCapacity':'float32',
    'Census_PrimaryDiskTypeName':'category',
    'Census_SystemVolumeTotalCapacity':'float32',
    'Census_HasOpticalDiskDrive':'int8',
    'Census_TotalPhysicalRAM':'float32',
    'Census_ChassisTypeName':'category',
    'Census_InternalPrimaryDiagonalDisplaySizeInInches':'float16',
    'Census_InternalPrimaryDisplayResolutionHorizontal':'float16',
    'Census_InternalPrimaryDisplayResolutionVertical':'float16',
    'Census_PowerPlatformRoleName':'category',
    'Census_InternalBatteryType':'category',
    'Census_InternalBatteryNumberOfCharges':'float32',
    'Census_OSVersion':'category',
    'Census_OSArchitecture':'category',
    'Census_OSBranch':'category',
    'Census_OSBuildNumber':'int16',
    'Census_OSBuildRevision':'int32',
    'Census_OSEdition':'category',
    'Census_OSSkuName':'category',
    'Census_OSInstallTypeName':'category',
    'Census_OSInstallLanguageIdentifier':'float16',
    'Census_OSUILocaleIdentifier':'int16',
    'Census_OSWUAutoUpdateOptionsName':'category',
    'Census_IsPortableOperatingSystem':'int8',
    'Census_GenuineStateName':'category',
    'Census_ActivationChannel':'category',
    'Census_IsFlightingInternal':'float16',
    'Census_IsFlightsDisabled':'float16',
    'Census_FlightRing':'category',
    'Census_ThresholdOptIn':'float16',
    'Census_FirmwareManufacturerIdentifier':'float16',
    'Census_FirmwareVersionIdentifier':'float32',
    'Census_IsSecureBootEnabled':'int8',
    'Census_IsWIMBootEnabled':'float16',
    'Census_IsVirtualDevice':'float16',
    'Census_IsTouchEnabled':'int8',
    'Census_IsPenCapable':'int8',
    'Census_IsAlwaysOnAlwaysConnectedCapable':'float16',
    'Wdft_IsGamer':'float16',
    'Wdft_RegionIdentifier':'float16',
    'HasDetections':'int8'
}

###########################################
# Load dataset
###########################################

train = pd.read_csv('train.csv.zip', dtype=dtypes, compression='zip')
test = pd.read_csv('test.csv.zip', dtype=dtypes, compression='zip')

test['HasDetections'] = np.nan
df = pd.concat([train,test])

gc.enable()

del train, test

total_index = df.shape[0]

gc.collect()

###########################################
# SmartScreen
###########################################

smartscreen = {
    '&#x01;'   : 'other',
    '&#x02;'   : 'other',
    '&#x03;'   : 'other',
    '0'        : 'other',
    '00000000' : 'other',
    'BLOCK'    : 'Block',
    'Deny'     : 'Block',
    'Enabled'  : 'On',
    'OFF'      : 'Off',
    'ON'       : 'On',
    'Promprt'  : 'Prompt',
    'Promt'    : 'Prompt',
    'RequiredAdmin' : 'RequireAdmin',
    'of'       : 'Off',
    'on'       : 'On',
    'prompt'   : 'Prompt',
    'requireAdmin'  : 'RequireAdmin',
    'requireadmin'  : 'RequireAdmin',
    'warn'     : 'Warn'
}

for key in smartscreen:
    df['SmartScreen'] = df['SmartScreen'].str.replace("\A"+str(key)+"\Z",smartscreen[key])

gc.collect()

###########################################
# Census_DeviceFamily
###########################################

del df['Census_DeviceFamily']

device_dict = {
    'AllInOne':'Desktop',
    'Convertible':'Desktop',
    'Desktop':'Desktop',
    'IoTOther':'Desktop',
    'LargeServer':'Server',
    'LargeTablet':'Desktop',
    'MediumServer':'Server',
    'Notebook':'Desktop',
    'PCOther':'Desktop',
    'ServerOther':'Desktop',
    'SmallServer':'Server',
    'SmallTable':'Desktop'
}

device_df = pd.DataFrame.from_dict(device_dict,'index')
device_df.columns = ['Census_DeviceFamily']

df = df.merge(device_df, left_on='Census_MDC2FormFactor', right_index=True, how='left').fillna(np.nan)

del device_dict, device_df

gc.collect()

###########################################
# Census_ChassisTypeName
###########################################

chassistype = {
    1 : 'Other',
    2 : 'Unknown',
    3 : 'Desktop',
    4 : 'LowProfileDesktop',
    5 : 'Pizza Box',
    6 : 'MiniTower',
    7 : 'Tower',
    8 : 'Portable',
    9 : 'Laptop',
    10: 'Notebook',
    11: 'HandHeld',
    12: 'DockingStation',
    13: 'AllinOne',
    14: 'SubNotebook',
    15: 'SpaceSaving',
    16: 'LunchBox',
    17: 'MainSystemChassis',
    18: 'ExpansionChassis',
    19: 'SubChassis',
    20: 'BusExpansionChassis',
    21: 'PeripheralChassis',
    22: 'RAID Chassis',
    23: 'RackMountChassis',
    24: 'SealedCasePC',
    25: 'MultisystemChassis',
    26: 'CompactPCI',
    27: 'AdvancedTCA',
    28: 'Blade',
    29: 'BladeEnclosure',
    30: 'Tablet',
    31: 'Convertible',
    32: 'Detachable',
    33: 'IoTGateway',
    34: 'EmbeddedPC',
    35: 'MiniPC',
    36: 'StickPC',
}

for key in chassistype:
    df['Census_ChassisTypeName'] = df['Census_ChassisTypeName'].str.replace("\A"+str(key)+"\Z",chassistype[key])

df['Census_ChassisTypeName'] = df['Census_ChassisTypeName'].str.replace("\A0\Z","Other")
df['Census_ChassisTypeName'] = df['Census_ChassisTypeName'].str.replace("\d+","Unknown")
df['Census_ChassisTypeName'] = df['Census_ChassisTypeName'].str.replace("UNKNOWN","Unknown")

gc.collect()

###########################################
# Census_PowerPlatformRoleName
###########################################

df['Census_PowerPlatformRoleName'] = df['Census_PowerPlatformRoleName'].str.replace("UNKNOWN","Unspecified")

gc.collect()

###########################################
# Census_InternalBatteryType
###########################################

df['Census_InternalBatteryType'] = df['Census_InternalBatteryType'].str.extract('(li)',expand=True)
df['Census_InternalBatteryType'] = df['Census_InternalBatteryType'].fillna('other')

gc.collect()

###########################################
# Census_FlightRing
###########################################

df['Census_IsFlightingInternal'] = df['Census_IsFlightingInternal'].fillna(1)
df['Census_IsFlightsDisabled'] = df['Census_IsFlightsDisabled'].fillna(1)

df['Census_FlightRing'] = df['Census_FlightRing'].str.replace('CBCanary', 'Canary')
df['Census_FlightRing'] = df['Census_FlightRing'].str.replace('Disabled', 'NOT_SET')
df['Census_FlightRing'] = df['Census_FlightRing'].str.replace('Invalid', 'NOT_SET')

gc.collect()

###########################################
# Save
###########################################

train_df = df.loc[:8921482,]

test_df = df[df['HasDetections'].apply(np.isnan)]

del test_df['HasDetections']

train_df.to_csv('train_rev.csv.zip', index=False, compression='zip')
test_df.to_csv('test_rev.csv.zip', index=False, compression='zip')

gc.collect()
